module.exports = function(grunt) {
  grunt.loadNpmTasks('grunt-contrib-uglify');
  grunt.loadNpmTasks('grunt-gjslint');

  var targetConfig = require('./target-config.js');

  uglifyTargets = {};
  gentestTargets = {};
  gendevTargets = {};
  for (var target in targetConfig) {
    uglifyTargets[target] = {
      options: {
        sourceMap: true,
        sourceMapName: 'web-animations-' + target + '.min.js.map',
        banner: grunt.file.read('src/boilerplate'),
        wrap: true,
        compress: {
          global_defs: {
            "TESTING": false
          },
          dead_code: true
        },
        mangle: {
          eval: true
        },
      },
      nonull: true,
      dest: 'web-animations-' + target + '.min.js',
      src: targetConfig[target].src.map(function(file) {return 'src/' + file;}),
    };
    gentestTargets[target] = targetConfig[target].test;
    gendevTargets[target] = targetConfig[target].src;
  }

  grunt.initConfig({
    uglify: uglifyTargets,
    gendev: gendevTargets,
    gentest: gentestTargets,
    gjslint: {
      options: {
        flags: [
          '--nojsdoc',
          '--nostrict',
          '--disable 121,110', // 121: Illegal comma at end of object literal
                               // 110: Line too long
        ],
        reporter: {
          name: 'console'
        }
      },
      all: {
        src: [
          'src/*.js',
          'test/*.js',
          'test/js/*.js',
        ],
      }
    },
  });

  grunt.task.registerMultiTask('gendev', 'Generate web-animations-<target>.dev.js', function() {
    grunt.log.writeln('TODO: Create web-animations-' + this.target + '.dev.js');
  });

  grunt.task.registerMultiTask('gentest', 'Generate test/runner-<target>.html', function() {
    grunt.log.writeln('TODO: Create test/runner-' + this.target + '.html');
    // grunt.log.writeln(this.target + ': ' + this.data);
  });

  grunt.registerTask('clean', 'Remove files generated by grunt', function() {
    grunt.file.expand('web-animations*').forEach(function(file) {
      console.log('Removing ' + file);
      grunt.file.delete(file);
    });
  });

  grunt.registerTask('default', ['uglify', 'gendev', 'gentest', 'gjslint']);
};
